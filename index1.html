<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Product Inventory Search</title>
  <style>
    :root {
      --bg-color: #050505;
      --text-color: #f5f5f5;
      --card-bg: #ffffff;
      --card-text: #000000;
      --input-bg: #111111;
      --input-border: #444444;
      --button-bg: #3498db;
      --button-text: #ffffff;
      --accent: #3498db;
    }

    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 0 16px;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s ease, color 0.3s ease;
    }

    body.dark {
      --bg-color: #050505;
      --text-color: #f5f5f5;
      --card-bg: #ffffff;
      --card-text: #000000;
      --input-bg: #111111;
      --input-border: #444444;
      --button-bg: #3498db;
      --button-text: #ffffff;
      --accent: #3498db;
    }

    body.light {
      --bg-color: #f5f5f5;
      --text-color: #111111;
      --card-bg: #ffffff;
      --card-text: #000000;
      --input-bg: #ffffff;
      --input-border: #cccccc;
      --button-bg: #111111;
      --button-text: #ffffff;
      --accent: #111111;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    h1 {
      margin: 0;
      text-align: left;
    }

    .theme-toggle {
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      background: var(--button-bg);
      color: var(--button-text);
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s, transform 0.1s;
    }

    .theme-toggle:hover {
      transform: translateY(-1px);
    }

    .search-box {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .search-box input,
    .search-box select,
    .suggestion-form input,
    .suggestion-form textarea {
      padding: 8px 10px;
      font-size: 16px;
      background: var(--input-bg);
      color: var(--text-color);
      border: 1px solid var(--input-border);
      border-radius: 6px;
    }

    .search-box input::placeholder,
    .suggestion-form input::placeholder,
    .suggestion-form textarea::placeholder {
      color: #888;
    }

    .search-box input {
      flex: 1 1 200px;
    }

    .search-box select {
      flex: 0 0 180px;
    }

    .search-box button,
    .suggestion-form button {
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 6px;
      border: none;
      background: var(--button-bg);
      color: var(--button-text);
      flex: 0 0 auto;
      transition: background 0.2s, transform 0.1s;
    }

    .search-box button:hover,
    .suggestion-form button:hover {
      transform: translateY(-1px);
    }

    .result-card {
      background: var(--card-bg);
      color: var(--card-text);
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 12px;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeIn 0.4s forwards;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 8px;
    }

    .result-model {
      font-weight: bold;
      color: #555;
      margin: 0 0 4px;
    }

    .result-name {
      font-size: 20px;
      font-weight: bold;
      margin: 0 0 4px;
    }

    .result-meta {
      font-size: 14px;
      margin: 0;
    }

    .result-description {
      margin: 10px 0 0;
    }

    .result-image {
      margin-top: 16px;
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .result-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .compare-toggle {
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      user-select: none;
    }

    .compare-toggle input {
      cursor: pointer;
    }

    .add-cart-btn {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #ffffff;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      white-space: nowrap;
    }

    .add-cart-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    @keyframes fadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .loader {
      border: 6px solid #ccc;
      border-top: 6px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .no-result {
      margin-top: 10px;
      color: #ff6666;
      font-weight: bold;
      display: none;
    }

    /* Compare section */
    #compareSection {
      margin-top: 30px;
      padding: 16px;
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--input-border);
      display: none;
    }

    .compare-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .compare-count {
      font-size: 14px;
      opacity: 0.8;
    }

    .clear-compare-btn {
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      background: transparent;
      color: var(--text-color);
      cursor: pointer;
    }

    .clear-compare-btn:hover {
      background: rgba(255,255,255,0.05);
    }

    .compare-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      overflow-x: auto;
    }

    .compare-table th,
    .compare-table td {
      border: 1px solid var(--input-border);
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }

    .compare-table th {
      background: rgba(0,0,0,0.1);
      font-weight: bold;
    }

    .compare-image {
      max-width: 100px;
      border-radius: 6px;
      border: 1px solid #ddd;
      display: block;
    }

    /* Cart / Quotation section */
    #cartSection {
      margin-top: 30px;
      padding: 16px;
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--input-border);
      display: none;
    }

    .cart-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .cart-count {
      font-size: 14px;
      opacity: 0.8;
    }

    .cart-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .cart-table th,
    .cart-table td {
      border: 1px solid var(--input-border);
      padding: 8px;
      text-align: left;
      vertical-align: middle;
    }

    .cart-table th {
      background: rgba(0,0,0,0.1);
      font-weight: bold;
    }

    .remove-cart-btn {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      background: transparent;
      color: var(--text-color);
      cursor: pointer;
    }

    .remove-cart-btn:hover {
      background: rgba(255,255,255,0.06);
    }

    .download-quote-btn {
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }

    .download-quote-btn:hover {
      opacity: 0.9;
    }

    /* Suggestion Box */
    #suggestionSection {
      margin-top: 30px;
      padding: 16px;
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--input-border);
    }

    #suggestionSection h2 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 18px;
    }

    .suggestion-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }

    .suggestion-form textarea {
      grid-column: 1 / -1;
      resize: vertical;
      min-height: 60px;
    }

    .suggestion-form button {
      grid-column: 1 / -1;
      justify-self: flex-start;
    }

    .suggestion-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .suggestion-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 220px;
      overflow-y: auto;
    }

    .suggestion-card {
      background: rgba(0,0,0,0.25);
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid var(--input-border);
      font-size: 14px;
    }

    .suggestion-card-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
      font-weight: bold;
    }

    .suggestion-card-meta {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 4px;
    }

    .copy-suggestions-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      background: transparent;
      color: var(--text-color);
      cursor: pointer;
      font-size: 13px;
    }

    .copy-suggestions-btn:hover {
      background: rgba(255,255,255,0.06);
    }

    @media (max-width: 600px) {
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .search-box {
        flex-direction: column;
      }
      .search-box button {
        width: 100%;
      }
      .suggestion-form {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body class="dark">

  <div class="top-bar">
    <h1>Inventory Search by JAY</h1>
    <button id="themeToggle" class="theme-toggle">Switch to Light Mode</button>
  </div>

  <div class="search-box">
    <select id="categorySelect">
      <option value="all">All Categories</option>
      <option value="camera">Cameras</option>
      <option value="converter">Converters</option>
      <option value="accessory">Accessories</option>
    </select>

    <input
      type="text"
      id="searchInput"
      placeholder="Enter model, product name or brand"
    >
    <button id="searchButton">Search</button>
  </div>

  <div id="noResult" class="no-result"></div>

  <div id="loader" class="loader"></div>

  <div id="resultsContainer"></div>

  <!-- Cart / Quotation -->
  <section id="cartSection">
    <div class="cart-actions">
      <span class="cart-count" id="cartCountText"></span>
      <button class="download-quote-btn" onclick="downloadQuotation()">Download quotation (Excel)</button>
    </div>
    <div id="cartContainer"></div>
  </section>

  <!-- Compare section -->
  <section id="compareSection">
    <div class="compare-actions">
      <span class="compare-count" id="compareCountText"></span>
      <button class="clear-compare-btn" onclick="clearCompare()">Clear comparison</button>
    </div>
    <div id="compareContainer"></div>
  </section>

  <!-- Suggestion Box -->
  <section id="suggestionSection">
    <h2>Product Suggestion Box</h2>
    <p style="font-size:14px; opacity:0.8; margin-bottom:10px;">
      Can't find a product? Suggest it here so it can be added to the inventory list.
    </p>

    <form id="suggestionForm" class="suggestion-form">
      <input type="text" id="suggestBrand" placeholder="Brand (e.g. SONY)" required>
      <input type="text" id="suggestModel" placeholder="Model (e.g. PXW-Z90)" required>
      <input type="text" id="suggestName" placeholder="Product name / short title" >
      <textarea id="suggestNotes" placeholder="Extra details (link, specs, customer request, etc.)"></textarea>
      <button type="submit">Add suggestion</button>
    </form>

    <div class="suggestion-actions">
      <span id="suggestionCountText">No suggestions yet.</span>
      <button type="button" class="copy-suggestions-btn" onclick="copySuggestions()">
        Copy all suggestions
      </button>
    </div>

    <div id="suggestionsList" class="suggestion-list"></div>
  </section>

  <script>
    const products = [
      {
        model: "DVDO-C4-1-B",
        brand: "DVDO",
        name: "DVDO PTZ CAMERA 1080P",
        category: "camera",
        description: "Full HD PTZ Camera with HDMI/IP/3G-SDI/USB & AI Auto Tracking (Black)",
        image: "https://dvdo.com/cdn/shop/products/DVDO-C4-1-2_700x.png?v=1672342619",
        specs: {
          "Resolution": "1080p",
          "Outputs": "HDMI, 3G-SDI, USB, IP",
          "AI Auto Tracking": "Yes",
          "Optical Zoom": "12x",
          "Color": "Black"
        }
      },
      {
        model: "DVDO-C5-1-B",
        brand: "DVDO",
        name: "DVDO PTZ CAMERA 4K",
        category: "camera",
        description: "4K PTZ Camera with HDMI/IP/3G-SDI/USB & AI Auto Tracking (Black)",
        image: "https://dvdo.com/cdn/shop/files/C5-1BlackFront-croppednoshade_700x.png?v=1713050748",
        specs: {
          "Resolution": "4K",
          "Outputs": "HDMI, 3G-SDI, USB, IP",
          "AI Auto Tracking": "Yes",
          "Optical Zoom": "12x",
          "Color": "Black"
        }
      },
      {
        model: "DVDO-CB-5-B",
        brand: "DVDO",
        name: "DVDO PTZ CAMERA BRACKET",
        category: "accessory",
        description: "Black Ceiling Bracket for C3 & C7WIFI PTZ Cameras",
        image: "https://dvdo.com/cdn/shop/files/DVDO-CB-5-Bpicture1_1024x.jpg?v=1748024159",
        specs: {
          "Type": "Ceiling Bracket",
          "Compatible Models": "C3, C7WIFI",
          "Color": "Black",
          "Material": "Metal"
        }
      },
      {
        model: "U-BRIDGE USB-C",
        brand: "INOGENI",
        name: "INOGENI USB BRIDGE",
        category: "converter",
        description: "USB-C EXT – USB and DP Alt Mode",
        image: "https://inogeni.com/wp-content/uploads/2025/03/Front-ISO-Hero-430x300-1.png",
        specs: {
          "Interface": "USB-C",
          "Function": "USB & DP Alt Mode Extension",
          "Use Case": "USB bridge / extender"
        }
      },
      {
        model: "SDI2USB3",
        brand: "INOGENI",
        name: "INOGENI SDI TO USB CONVERTER",
        category: "converter",
        description: "3G-SDI to USB 3.0 video converter (+ loop)",
        image: "https://inogeni.com/wp-content/uploads/2022/09/inogeni-sdi2usb3-header-product-1.png",
        specs: {
          "Input": "3G-SDI",
          "Output": "USB 3.0",
          "Loop Output": "Yes",
          "Max Resolution": "Up to 1080p"
        }
      },
      {
        model: "CAP-1",
        brand: "DATAVIDEO",
        name: "DATAVIDEO SDI TO USB CONVERTER",
        category: "converter",
        description: "3SDI to USB 3.0 Capture Box",
        image: "https://d3c9kujynjspib.cloudfront.net/images/33673c36e0c073fe12812e08.jpg",
        specs: {
          "Input": "3G-SDI",
          "Output": "USB 3.0",
          "Use Case": "Capture Box",
          "Max Resolution": "Up to 1080p"
        }
      }
    ];

    const searchInput       = document.getElementById("searchInput");
    const searchButton      = document.getElementById("searchButton");
    const noResultEl        = document.getElementById("noResult");
    const resultsContainer  = document.getElementById("resultsContainer");
    const loader            = document.getElementById("loader");
    const categorySelect    = document.getElementById("categorySelect");
    const compareSection    = document.getElementById("compareSection");
    const compareContainer  = document.getElementById("compareContainer");
    const compareCountText  = document.getElementById("compareCountText");
    const themeToggle       = document.getElementById("themeToggle");

    const cartSection       = document.getElementById("cartSection");
    const cartContainer     = document.getElementById("cartContainer");
    const cartCountText     = document.getElementById("cartCountText");

    // Suggestion elements
    const suggestionForm       = document.getElementById("suggestionForm");
    const suggestBrandInput    = document.getElementById("suggestBrand");
    const suggestModelInput    = document.getElementById("suggestModel");
    const suggestNameInput     = document.getElementById("suggestName");
    const suggestNotesInput    = document.getElementById("suggestNotes");
    const suggestionsListEl    = document.getElementById("suggestionsList");
    const suggestionCountText  = document.getElementById("suggestionCountText");

    let compareSelection = [];
    let cart = []; // { model, name, brand, description, quantity }
    let suggestions = []; // { brand, model, name, notes, createdAt }

    const SUGGESTIONS_STORAGE_KEY = "inventorySuggestions";

    /* ---------- THEME TOGGLE ---------- */

    function applyTheme(theme) {
      document.body.classList.remove("dark", "light");
      document.body.classList.add(theme);
      themeToggle.textContent = theme === "dark"
        ? "Switch to Light Mode"
        : "Switch to Dark Mode";
      localStorage.setItem("inventoryTheme", theme);
    }

    (function initTheme() {
      const saved = localStorage.getItem("inventoryTheme");
      if (saved === "dark" || saved === "light") {
        applyTheme(saved);
      } else {
        applyTheme("dark");
      }
    })();

    themeToggle.addEventListener("click", () => {
      const current = document.body.classList.contains("dark") ? "dark" : "light";
      const next = current === "dark" ? "light" : "dark";
      applyTheme(next);
    });

    /* ---------- SEARCH + FILTER ---------- */

    function searchProduct() {
      const query = searchInput.value.trim().toLowerCase();
      const selectedCategory = categorySelect.value;

      loader.style.display = "block";
      resultsContainer.innerHTML = "";
      noResultEl.style.display = "none";

      setTimeout(() => {
        const matches = products.filter(p => {
          const model = p.model.toLowerCase();
          const name  = p.name.toLowerCase();
          const brand = (p.brand || "").toLowerCase();
          const matchesText =
            !query ||
            model.includes(query) ||
            name.includes(query) ||
            brand.includes(query);
          const matchesCategory =
            (selectedCategory === "all") || (p.category === selectedCategory);
          return matchesText && matchesCategory;
        });

        loader.style.display = "none";

        if (matches.length === 0) {
          noResultEl.textContent = "No product found.";
          noResultEl.style.display = "block";
          return;
        }

        matches.forEach(product => {
          const card = document.createElement("div");
          card.className = "result-card";

          const isChecked = compareSelection.includes(product.model);

          card.innerHTML = `
            <div class="result-header">
              <div>
                <p class="result-model">Model: ${product.model}</p>
                <h2 class="result-name">${product.name}</h2>
                <p class="result-meta">
                  <strong>Brand:</strong> ${product.brand || "-"} |
                  <strong>Category:</strong> ${product.category.toUpperCase()}
                </p>
              </div>
              <div class="result-actions">
                <label class="compare-toggle">
                  <input
                    type="checkbox"
                    ${isChecked ? "checked" : ""}
                    onchange="toggleCompare(this, '${product.model}')"
                  >
                  Compare
                </label>
                <button class="add-cart-btn" onclick="addToCart('${product.model}')">
                  Add to cart
                </button>
              </div>
            </div>
            <p class="result-description">${product.description}</p>
            <img class="result-image" src="${product.image}" alt="${product.name}">
          `;

          resultsContainer.appendChild(card);
        });

        renderCompare();
      }, 500);
    }

    searchButton.addEventListener("click", searchProduct);
    searchInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") searchProduct();
    });
    categorySelect.addEventListener("change", searchProduct);

    // Initial load
    searchProduct();

    /* ---------- COMPARE ---------- */

    function toggleCompare(checkboxEl, model) {
      const index = compareSelection.indexOf(model);

      if (checkboxEl.checked) {
        if (compareSelection.length >= 3) {
          alert("You can compare up to 3 products at a time.");
          checkboxEl.checked = false;
          return;
        }
        if (index === -1) compareSelection.push(model);
      } else {
        if (index !== -1) compareSelection.splice(index, 1);
      }

      renderCompare();
    }

    function clearCompare() {
      compareSelection = [];
      renderCompare();

      const checkboxes = document.querySelectorAll(".compare-toggle input[type='checkbox']");
      checkboxes.forEach(cb => cb.checked = false);
    }

    function renderCompare() {
      if (compareSelection.length === 0) {
        compareSection.style.display = "none";
        compareContainer.innerHTML = "";
        compareCountText.textContent = "No products selected for comparison.";
        return;
      }

      const selectedProducts = products.filter(p =>
        compareSelection.includes(p.model)
      );

      compareSection.style.display = "block";
      compareCountText.textContent = `Comparing ${compareSelection.length} product(s).`;

      const specKeySet = new Set();
      selectedProducts.forEach(p => {
        if (p.specs) {
          Object.keys(p.specs).forEach(key => specKeySet.add(key));
        }
      });
      const specKeys = Array.from(specKeySet);

      let tableHtml = `
        <table class="compare-table">
          <tr>
            <th>Feature</th>
            ${selectedProducts.map(p => `<th>${p.name}</th>`).join("")}
          </tr>
          <tr>
            <th>Image</th>
            ${selectedProducts.map(p => `
              <td>
                <img class="compare-image" src="${p.image}" alt="${p.name}">
              </td>
            `).join("")}
          </tr>
          <tr>
            <th>Model</th>
            ${selectedProducts.map(p => `<td>${p.model}</td>`).join("")}
          </tr>
          <tr>
            <th>Brand</th>
            ${selectedProducts.map(p => `<td>${p.brand || "-"}</td>`).join("")}
          </tr>
          <tr>
            <th>Category</th>
            ${selectedProducts.map(p => `<td>${p.category.toUpperCase()}</td>`).join("")}
          </tr>
          <tr>
            <th>Description</th>
            ${selectedProducts.map(p => `<td>${p.description}</td>`).join("")}
          </tr>
      `;

      if (specKeys.length > 0) {
        tableHtml += `
          <tr>
            <th colspan="${selectedProducts.length + 1}">Specifications</th>
          </tr>
        `;

        specKeys.forEach(key => {
          tableHtml += `
            <tr>
              <th>${key}</th>
              ${selectedProducts.map(p => `<td>${(p.specs && p.specs[key]) ? p.specs[key] : "-"}</td>`).join("")}
            </tr>
          `;
        });
      }

      tableHtml += `</table>`;

      compareContainer.innerHTML = tableHtml;
    }

    /* ---------- CART / QUOTATION ---------- */

    function addToCart(model) {
      const product = products.find(p => p.model === model);
      if (!product) return;

      const existing = cart.find(item => item.model === model);
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({
          model: product.model,
          name: product.name,
          brand: product.brand || "",
          description: product.description,
          quantity: 1
        });
      }

      renderCart();
    }

    function removeFromCart(model) {
      cart = cart.filter(item => item.model !== model);
      renderCart();
    }

    function updateCartQuantity(model, newQty) {
      const qty = parseInt(newQty, 10);
      if (isNaN(qty) || qty <= 0) return;
      const item = cart.find(i => i.model === model);
      if (!item) return;
      item.quantity = qty;
      renderCart();
    }

    function renderCart() {
      if (cart.length === 0) {
        cartSection.style.display = "none";
        cartContainer.innerHTML = "";
        cartCountText.textContent = "Cart is empty.";
        return;
      }

      cartSection.style.display = "block";

      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      cartCountText.textContent = `Cart: ${cart.length} product(s), ${totalItems} item(s) total.`;

      let tableHtml = `
        <table class="cart-table">
          <tr>
            <th>Brand</th>
            <th>Model</th>
            <th>Description</th>
            <th style="width: 80px;">Qty</th>
            <th>Action</th>
          </tr>
          ${cart.map(item => `
            <tr>
              <td>${item.brand || "-"}</td>
              <td>${item.model}</td>
              <td>${item.description}</td>
              <td>
                <input
                  type="number"
                  min="1"
                  value="${item.quantity}"
                  style="width: 60px;"
                  onchange="updateCartQuantity('${item.model}', this.value)"
                >
              </td>
              <td>
                <button class="remove-cart-btn" onclick="removeFromCart('${item.model}')">
                  Remove
                </button>
              </td>
            </tr>
          `).join("")}
        </table>
      `;

      cartContainer.innerHTML = tableHtml;
    }

    function csvEscape(value) {
      if (value == null) return "";
      const str = String(value);
      if (/[",\n\r]/.test(str)) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }

    function downloadQuotation() {
      if (cart.length === 0) {
        alert("Cart is empty. Add products before generating a quotation.");
        return;
      }

      const rows = [];
      // Brand first, then Model, Description, Quantity
      rows.push(["Brand", "Model", "Description", "Quantity"]);

      cart.forEach(item => {
        rows.push([
          csvEscape(item.brand || ""),
          csvEscape(item.model),
          csvEscape(item.description),
          csvEscape(item.quantity)
        ]);
      });

      const csvContent = rows.map(r => r.join(",")).join("\r\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });

      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      const today = new Date().toISOString().slice(0, 10);

      link.href = url;
      link.download = `quotation_${today}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    /* ---------- SUGGESTION BOX ---------- */

    function loadSuggestions() {
      try {
        const raw = localStorage.getItem(SUGGESTIONS_STORAGE_KEY);
        if (raw) {
          suggestions = JSON.parse(raw) || [];
        }
      } catch (e) {
        suggestions = [];
      }
      renderSuggestions();
    }

    function saveSuggestions() {
      localStorage.setItem(SUGGESTIONS_STORAGE_KEY, JSON.stringify(suggestions));
    }

    function renderSuggestions() {
      if (!suggestions.length) {
        suggestionsListEl.innerHTML = "";
        suggestionCountText.textContent = "No suggestions yet.";
        return;
      }

      suggestionCountText.textContent = `Total suggestions: ${suggestions.length}`;

      suggestionsListEl.innerHTML = suggestions.map(s => `
        <div class="suggestion-card">
          <div class="suggestion-card-header">
            <span>${s.brand || "-"} • ${s.model || "-"}</span>
          </div>
          <div class="suggestion-card-meta">
            ${s.name ? `${s.name} • ` : ""}${s.createdAt}
          </div>
          <div>${s.notes ? s.notes : ""}</div>
        </div>
      `).join("");
    }

    suggestionForm.addEventListener("submit", (event) => {
      event.preventDefault();

      const brand = suggestBrandInput.value.trim();
      const model = suggestModelInput.value.trim();
      const name  = suggestNameInput.value.trim();
      const notes = suggestNotesInput.value.trim();

      if (!brand || !model) {
        alert("Please provide at least Brand and Model.");
        return;
      }

      const createdAt = new Date().toLocaleString();

      suggestions.push({ brand, model, name, notes, createdAt });
      saveSuggestions();
      renderSuggestions();

      suggestionForm.reset();
      suggestBrandInput.focus();
    });

    function copySuggestions() {
      if (!suggestions.length) {
        alert("No suggestions to copy.");
        return;
      }

      const lines = [];
      lines.push("Brand, Model, Name, Notes, Created At");
      suggestions.forEach(s => {
        const row = [
          csvEscape(s.brand || ""),
          csvEscape(s.model || ""),
          csvEscape(s.name || ""),
          csvEscape(s.notes || ""),
          csvEscape(s.createdAt || "")
        ].join(",");
        lines.push(row);
      });

      const text = lines.join("\n");

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => alert("All suggestions copied to clipboard."))
          .catch(() => alert("Failed to copy. You can select and copy manually."));
      } else {
        alert("Clipboard not available. You can select and copy the text from the suggestions list.");
      }
    }

    // Load suggestions on startup
    loadSuggestions();

    // Expose functions
    window.toggleCompare      = toggleCompare;
    window.clearCompare       = clearCompare;
    window.addToCart          = addToCart;
    window.removeFromCart     = removeFromCart;
    window.updateCartQuantity = updateCartQuantity;
    window.downloadQuotation  = downloadQuotation;
    window.copySuggestions    = copySuggestions;
  </script>
</body>
</html>
