d. Check deployment permissions / access.");
        return;
      }

      // Refresh lists from backend for consistency
      await loadProductsFromBackend();
      await loadCategoriesFromBackend();

      productForm.reset();
      editingProductIndex = null;
      productFormSubmitBtn.textContent = "Add product";
      productFormCancelEditBtn.style.display = "none";
      adminWarn.style.display = "none";

      renderCategoryOptions();
      renderAdminCategoryDropdown();
      renderCategoryManager();
      renderAdminProducts();
      searchProduct();
    });

    function startEditProduct(index){
      if(!isAdmin) return;
      const p = products[index];
      if(!p) return;

      editingProductIndex = index;
      prodBrandInput.value = p.brand || "";
      prodModelInput.value = p.model || "";
      prodNameInput.value = p.name || "";
      renderAdminCategoryDropdown(p.category || "");
      prodImageInput.value = p.image || "";
      prodDescriptionInput.value = p.description || "";
      prodSpecsInput.value = specsToText(p.specs);

      productFormSubmitBtn.textContent = "Save changes";
      productFormCancelEditBtn.style.display = "inline-block";
      liveAdminWarn_();

      window.scrollTo({ top: document.getElementById("adminSection").offsetTop, behavior: "smooth" });
    }

    async function deleteProduct(index){
      if(!isAdmin) return;
      const p = products[index];
      if(!p) return;
      if(!confirm(`Delete product ${p.model}?`)) return;

      const res = await apiPost("delete_product", { model: p.model });
      if(!res || !res.ok){
        alert("Failed to delete product from backend.");
        return;
      }

      // remove from cart
      cart = cart.filter(item => item.model !== p.model);

      await loadProductsFromBackend();
      await loadCategoriesFromBackend();

      renderCart();
      renderCategoryOptions();
      renderAdminCategoryDropdown();
      renderCategoryManager();
      renderAdminProducts();
      searchProduct();
    }

    function cancelProductEdit(){
      editingProductIndex = null;
      productForm.reset();
      productFormSubmitBtn.textContent = "Add product";
      productFormCancelEditBtn.style.display = "none";
      adminWarn.style.display = "none";
      renderAdminCategoryDropdown();
    }

    /***********************
     * INIT
     ***********************/
    async function init(){
      // quote meta
      loadQuoteMeta();
      bindQuoteMetaInputs();

      // load backend (shared)
      loader.style.display = "block";
      await loadProductsFromBackend();
      await loadCategoriesFromBackend();
      loader.style.display = "none";

      renderCategoryOptions();
      renderAdminCategoryDropdown();
      loadSuggestions();
      initAdmin();
      renderCategoryManager();
      renderAdminProducts();
      searchProduct();
      renderCart();

      // Default date
      if(!qmDate.value) qmDate.value = new Date().toISOString().slice(0,10);
    }

    // expose global functions
    window.addToCart = addToCart;
    window.removeFromCart = removeFromCart;
    window.updateCartQuantity = updateCartQuantity;
    window.updateCartUnitCost = updateCartUnitCost;
    window.downloadBOQCsv = downloadBOQCsv;

    window.copySuggestions = copySuggestions;

    window.adminLogout = adminLogout;
    window.startEditProduct = startEditProduct;
    window.deleteProduct = deleteProduct;
    window.cancelProductEdit = cancelProductEdit;

    window.refreshFromBackend = refreshFromBackend;

    window.addCategory = addCategory;
    window.renameCategoryLabel = renameCategoryLabel;
    window.renameCategoryKey = renameCategoryKey;
    window.deleteCategory = deleteCategory;

    init();
  </script>
</body>
</html>
